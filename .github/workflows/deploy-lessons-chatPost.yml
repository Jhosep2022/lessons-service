name: Deploy lessons-chatPost Lambda (direct)

on:
  push:
    branches: [main, qa]

jobs:
  deploy:
    name: Deploy lessons chatPost
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'dev' || 'qa' }}

    # STAGE por rama (main â†’ dev, qa â†’ qa)
    env:
      STAGE: ${{ github.ref == 'refs/heads/main' && 'dev' || 'qa' }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      # instala deps (raÃ­z o subcarpeta, igual que ya tenÃ­as)
      - name: ðŸ“¦ Install deps (subdir)
        if: ${{ hashFiles('lessons-service/package.json') != '' }}
        working-directory: lessons-service
        run: |
          if [ -f package-lock.json ]; then npm ci --omit=dev; else npm i --omit=dev; fi
      - name: ðŸ“¦ Install deps (root)
        if: ${{ hashFiles('lessons-service/package.json') == '' && hashFiles('package.json') != '' }}
        run: |
          if [ -f package-lock.json ]; then npm ci --omit=dev; else npm i --omit=dev; fi

      - name: ðŸ“¦ Package (subdir)
        if: ${{ hashFiles('lessons-service/package.json') != '' }}
        working-directory: lessons-service
        run: zip -r lessons-chatPost.zip src/ node_modules/ package.json package-lock.json || true
      - name: ðŸ“¦ Package (root)
        if: ${{ hashFiles('lessons-service/package.json') == '' && hashFiles('package.json') != '' }}
        run: zip -r lessons-chatPost.zip src/ node_modules/ package.json package-lock.json || true

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # ðŸš€ Deploy (subdir)
      - name: ðŸš€ Deploy (subdir)
        if: ${{ hashFiles('lessons-service/package.json') != '' }}
        working-directory: lessons-service
        run: |
          aws lambda update-function-configuration \
            --function-name lessons-service-$STAGE-chatPost \
            --environment "Variables={
              STAGE=${{env.STAGE}},
              COURSES_TABLE_NAME=${{secrets.COURSES_TABLE_NAME}},
              LESSONS_TABLE_NAME=${{secrets.LESSONS_TABLE_NAME}},
              ALLOWED_ORIGINS=${{secrets.ALLOWED_ORIGINS}}
            }"
          aws lambda update-function-code \
            --function-name lessons-service-$STAGE-chatPost \
            --zip-file fileb://lessons-chatPost.zip \
            --publish

      # ðŸš€ Deploy (root)
      - name: ðŸš€ Deploy (root)
        if: ${{ hashFiles('lessons-service/package.json') == '' && hashFiles('package.json') != '' }}
        run: |
          aws lambda update-function-configuration \
            --function-name lessons-service-$STAGE-chatPost \
            --environment "Variables={
                STAGE=${{env.STAGE}},
                COURSES_TABLE_NAME=${{secrets.COURSES_TABLE_NAME}},
                LESSONS_TABLE_NAME=${{secrets.LESSONS_TABLE_NAME}},
                ALLOWED_ORIGINS=${{secrets.ALLOWED_ORIGINS}}
              }"
          aws lambda update-function-code \
            --function-name lessons-service-$STAGE-chatPost \
            --zip-file fileb://lessons-chatPost.zip \
            --publish
